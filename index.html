<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courier Parcel Management System - Improved</title>
    
    <!-- ‚úÖ IMPROVED: SheetJS Library for proper Excel file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- ü§ñ AI INTEGRATION: Tesseract.js for OCR (Photo to AWB scanning) - 100% FREE -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 25px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header p {
            color: #666;
            font-size: 1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
        }

        .stat-card:active {
            transform: translateY(-2px);
        }

        .stat-card h3 {
            color: #999;
            font-size: 0.85em;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab {
            background: white;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .scanner-box {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #667eea;
        }

        .scanner-input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s;
        }

        .scanner-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #4ade80;
            color: white;
        }

        .btn-success:hover {
            background: #22c55e;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #667eea;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .notification.success {
            background: #10b981;
            color: white;
        }

        .notification.error {
            background: #ef4444;
            color: white;
        }

        .notification.info {
            background: #3b82f6;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -600px;
            width: 600px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0,0,0,0.3);
            transition: right 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-header {
            background: #667eea;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sidebar-content {
            padding: 20px;
        }

        .close-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .awb-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .awb-item {
            background: #f8f9ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .alert-success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .alert-danger {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #7f1d1d;
        }

        .alert-info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }

        .upload-zone {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            background: #f8f9ff;
            border-color: #5568d3;
        }

        .upload-status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
        }

        .upload-status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .upload-status.error {
            background: #fee2e2;
            color: #7f1d1d;
        }

        /* NEW: Red Parcels in Assignment Section Styles */
        .red-parcels-container {
            background: #fff5f5;
            border: 2px solid #ef4444;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .red-parcels-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #fee2e2;
        }

        .red-parcels-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .red-stat-box {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .red-stat-box .label {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 5px;
        }

        .red-stat-box .value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .red-stat-box.rto .value {
            color: #ef4444;
        }

        .red-stat-box.unattempt .value {
            color: #f59e0b;
        }

        .red-stat-box.unavailable .value {
            color: #3b82f6;
        }

        .red-stat-box.scanned .value {
            color: #10b981;
        }

        .red-parcels-list {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border-radius: 6px;
            padding: 10px;
        }

        .red-parcel-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .red-parcel-item.rto {
            background: #fee2e2;
            border-left: 3px solid #ef4444;
        }

        .red-parcel-item.unattempt {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
        }

        .red-parcel-item.unavailable {
            background: #dbeafe;
            border-left: 3px solid #3b82f6;
        }

        .red-parcel-item.scanned {
            background: #d1fae5;
            border-left: 3px solid #10b981;
            opacity: 0.7;
        }

        .status-badge {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .status-badge.rto {
            background: #ef4444;
            color: white;
        }

        .status-badge.unattempt {
            background: #f59e0b;
            color: white;
        }

        .status-badge.unavailable {
            background: #3b82f6;
            color: white;
        }

        .status-badge.scanned {
            background: #10b981;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üì¶ Courier Parcel Management</h1>
            <p>Advanced parcel tracking and assignment system with automated yesterday sheet management</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card" onclick="switchTab('assign')">
                <h3>Total Riders</h3>
                <div class="number" id="totalRiders">0</div>
            </div>
            <div class="stat-card" onclick="switchTab('assign')">
                <h3>Assigned Parcels</h3>
                <div class="number" id="totalAssignments">0</div>
            </div>
            <div class="stat-card" onclick="viewYesterdayStatus()">
                <h3>Yesterday's Red</h3>
                <div class="number" id="totalRedParcels" style="color: #ef4444;">0</div>
            </div>
            <div class="stat-card" onclick="switchTab('assign')">
                <h3>Scanned Red</h3>
                <div class="number" id="totalScannedRed" style="color: #10b981;">0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('riders')">üßë‚Äçüíº Rider Management</div>
            <div class="tab" onclick="switchTab('assign')">üìã Assign Parcels</div>
            <div class="tab" onclick="switchTab('yesterday')">üî¥ Yesterday Status</div>
            <div class="tab" onclick="switchTab('history')">üìä History</div>
        </div>

        <!-- Rider Management Section -->
        <div id="ridersSection" class="section active">
            <h2>üßë‚Äçüíº Rider Management</h2>
            
            <div class="form-group">
                <label>Rider Name</label>
                <input type="text" id="riderName" placeholder="Enter rider name">
            </div>
            
            <div class="form-group">
                <label>Mobile Number</label>
                <input type="tel" id="riderMobile" placeholder="Enter mobile number">
            </div>
            
            <button class="btn btn-primary" onclick="addRider()">‚ûï Add Rider</button>
            
            <table id="ridersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Assigned</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ridersTableBody"></tbody>
            </table>
        </div>

        <!-- Assign Parcels Section -->
        <div id="assignSection" class="section">
            <h2>üìã Assign Parcels to Rider</h2>
            
            <div class="form-group">
                <label>Select Rider</label>
                <select id="assignRider" onchange="onRiderSelected()">
                    <option value="">-- Select Rider --</option>
                </select>
            </div>

            <!-- NEW: Red Parcels Display in Assignment Section -->
            <div id="redParcelsInAssignment" style="display: none;">
                <div class="red-parcels-container">
                    <div class="red-parcels-header">
                        <h3 style="color: #ef4444; margin: 0;">üî¥ Yesterday's Pending Parcels</h3>
                        <button class="btn btn-danger btn-small" onclick="showMissingRedParcels()">
                            üìã Show Missing
                        </button>
                    </div>
                    
                    <div class="red-parcels-stats">
                        <div class="red-stat-box rto">
                            <div class="label">RTO (Blocked)</div>
                            <div class="value" id="redStatRTO">0</div>
                        </div>
                        <div class="red-stat-box unattempt">
                            <div class="label">Unattempt</div>
                            <div class="value" id="redStatUnattempt">0</div>
                        </div>
                        <div class="red-stat-box unavailable">
                            <div class="label">Unavailable</div>
                            <div class="value" id="redStatUnavailable">0</div>
                        </div>
                        <div class="red-stat-box scanned">
                            <div class="label">Scanned ‚úì</div>
                            <div class="value" id="redStatScanned">0</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <strong>Quick View:</strong>
                        <select id="redParcelsFilter" onchange="filterRedParcelsDisplay()" style="padding: 5px; margin-left: 10px; border-radius: 4px;">
                            <option value="all">All Pending</option>
                            <option value="unattempt">Unattempt Only</option>
                            <option value="unavailable">Customer Unavailable Only</option>
                            <option value="rto">RTO (Blocked)</option>
                            <option value="scanned">Scanned</option>
                        </select>
                    </div>

                    <div class="red-parcels-list" id="redParcelsListContainer">
                        <!-- Red parcels will be displayed here -->
                    </div>
                </div>
            </div>

            <div class="scanner-box">
                <input type="text" class="scanner-input" id="assignScanner" 
                       placeholder="üì∑ Scan AWB number here..." 
                       onkeypress="handleAssignScan(event)">
                <div style="margin-top: 10px; color: #666; font-size: 0.9em;">
                    üí° Tip: Focus here and scan barcodes directly
                </div>
            </div>
            
            <div id="assignmentSummary" style="margin-bottom: 20px;"></div>
            
            <div id="assignmentList"></div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="completeAssignment()" id="completeBtn" style="display: none;">
                    ‚úÖ Complete Assignment
                </button>
                <button class="btn btn-danger" onclick="cancelAssignment()" id="cancelBtn" style="display: none;">
                    ‚ùå Cancel
                </button>
            </div>
        </div>

        <!-- Yesterday Status Section -->
        <div id="yesterdaySection" class="section">
            <h2>üî¥ Yesterday's Status Management</h2>
            
            <div class="alert alert-info">
                <strong>üìå Auto-Save Feature Enabled!</strong><br>
                <p style="margin-top: 10px;">
                    ‚Ä¢ Upload today's status file<br>
                    ‚Ä¢ System automatically saves it as "Yesterday's data" for tomorrow<br>
                    ‚Ä¢ Next day it becomes the previous day's data automatically<br>
                    ‚Ä¢ Process continues automatically every day
                </p>
            </div>

            <div class="upload-zone" onclick="document.getElementById('yesterdayFileInput').click()">
                <h3>üìÇ Upload Today's Status File (Excel/CSV)</h3>
                <p style="margin-top: 10px; color: #666;">
                    Click to upload or drag & drop<br>
                    <small>Supported: .xlsx, .xls, .csv</small>
                </p>
                <input type="file" id="yesterdayFileInput" accept=".xlsx,.xls,.csv" 
                       style="display: none;" onchange="handleYesterdayFileUpload(event)">
            </div>
            
            <div id="yesterdayFileUploadStatus"></div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="viewYesterdayStatus()">
                    üìä View Yesterday Summary
                </button>
                <button class="btn btn-danger" onclick="clearYesterdayStatus()">
                    üóëÔ∏è Clear Yesterday Data
                </button>
            </div>

            <div id="yesterdayStatusDisplay" style="margin-top: 20px;"></div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="section">
            <h2>üìä Assignment History</h2>
            <div id="historyContent">
                <p style="color: #666; text-align: center; padding: 40px;">No history available yet</p>
            </div>
        </div>
    </div>

    <!-- Sidebar for Unassigned Parcels -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>üì¶ Details</h3>
            <button class="close-btn" onclick="closeSidebar()">‚úï</button>
        </div>
        <div class="sidebar-content" id="unassignedContent"></div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DATA STRUCTURES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let riders = [];
        let assignments = {};
        let yesterdayStatus = {};
        let redParcels = {};
        let currentAssignmentRider = null;
        let assignmentHistory = [];
        
        // Auto-save configuration
        const AUTO_SAVE_KEY = 'courierSystemAutoSave';
        const LAST_UPDATE_KEY = 'courierSystemLastUpdate';

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INITIALIZATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        window.onload = function() {
            loadData();
            checkAndRotateYesterdayData();
            updateRidersDisplay();
            updateStats();
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AUTO YESTERDAY ROTATION SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function checkAndRotateYesterdayData() {
            const lastUpdate = localStorage.getItem(LAST_UPDATE_KEY);
            const today = new Date().toDateString();
            
            if (lastUpdate && lastUpdate !== today) {
                // New day detected - rotate data
                console.log('New day detected. Rotating yesterday data...');
                
                // Current "today" data becomes "yesterday" data
                const todayData = localStorage.getItem('todayStatusData');
                if (todayData) {
                    localStorage.setItem('yesterdayStatusData', todayData);
                    showNotification('‚úÖ Yesterday data auto-rotated for new day!', 'success');
                }
                
                // Update last update date
                localStorage.setItem(LAST_UPDATE_KEY, today);
            } else if (!lastUpdate) {
                // First time setup
                localStorage.setItem(LAST_UPDATE_KEY, today);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LOCAL STORAGE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function saveData() {
            const data = {
                riders,
                assignments,
                yesterdayStatus,
                redParcels,
                assignmentHistory
            };
            localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(data));
            localStorage.setItem(LAST_UPDATE_KEY, new Date().toDateString());
        }

        function loadData() {
            const saved = localStorage.getItem(AUTO_SAVE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                riders = data.riders || [];
                assignments = data.assignments || {};
                yesterdayStatus = data.yesterdayStatus || {};
                redParcels = data.redParcels || {};
                assignmentHistory = data.assignmentHistory || [];
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TAB SWITCHING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Section').classList.add('active');
            
            if (tab === 'assign') {
                updateAssignRiderDropdown();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RIDER MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function addRider() {
            const name = document.getElementById('riderName').value.trim();
            const mobile = document.getElementById('riderMobile').value.trim();
            
            if (!name || !mobile) {
                showNotification('‚ö†Ô∏è Please fill all fields', 'error');
                return;
            }
            
            if (riders.some(r => r.name.toLowerCase() === name.toLowerCase())) {
                showNotification('‚ö†Ô∏è Rider already exists', 'error');
                return;
            }
            
            const rider = {
                id: Date.now(),
                name,
                mobile,
                assigned: 0
            };
            
            riders.push(rider);
            assignments[rider.id] = [];
            
            saveData();
            updateRidersDisplay();
            updateStats();
            
            document.getElementById('riderName').value = '';
            document.getElementById('riderMobile').value = '';
            
            showNotification('‚úÖ Rider added successfully', 'success');
        }

        function deleteRider(id) {
            const rider = riders.find(r => r.id === id);
            if (!rider) return;
            
            if (confirm(`Delete rider: ${rider.name}?`)) {
                riders = riders.filter(r => r.id !== id);
                delete assignments[id];
                
                saveData();
                updateRidersDisplay();
                updateStats();
                
                showNotification('üóëÔ∏è Rider deleted', 'success');
            }
        }

        function updateRidersDisplay() {
            const tbody = document.getElementById('ridersTableBody');
            const table = document.getElementById('ridersTable');
            
            if (riders.length === 0) {
                table.style.display = 'none';
                return;
            }
            
            table.style.display = 'table';
            tbody.innerHTML = riders.map((rider, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td><strong>${rider.name}</strong></td>
                    <td>${rider.mobile}</td>
                    <td><span style="color: #667eea; font-weight: bold;">${assignments[rider.id]?.length || 0}</span></td>
                    <td>
                        <button class="btn btn-danger btn-small" onclick="deleteRider(${rider.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateAssignRiderDropdown() {
            const select = document.getElementById('assignRider');
            select.innerHTML = '<option value="">-- Select Rider --</option>' + 
                riders.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ASSIGNMENT MANAGEMENT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function onRiderSelected() {
            const riderId = document.getElementById('assignRider').value;
            
            if (!riderId) {
                currentAssignmentRider = null;
                document.getElementById('assignmentSummary').innerHTML = '';
                document.getElementById('assignmentList').innerHTML = '';
                document.getElementById('completeBtn').style.display = 'none';
                document.getElementById('cancelBtn').style.display = 'none';
                document.getElementById('redParcelsInAssignment').style.display = 'none';
                return;
            }
            
            currentAssignmentRider = parseInt(riderId);
            const rider = riders.find(r => r.id === currentAssignmentRider);
            
            // Show red parcels section if rider has yesterday's pending parcels
            const riderName = rider.name;
            if (redParcels[riderName]) {
                document.getElementById('redParcelsInAssignment').style.display = 'block';
                updateRedParcelsDisplay();
            } else {
                document.getElementById('redParcelsInAssignment').style.display = 'none';
            }
            
            updateAssignmentDisplay();
            document.getElementById('assignScanner').focus();
        }

        function handleAssignScan(event) {
            if (event.key === 'Enter') {
                const input = document.getElementById('assignScanner');
                const awb = input.value.trim().toUpperCase();
                
                if (!awb) return;
                
                if (!currentAssignmentRider) {
                    showNotification('‚ö†Ô∏è Please select a rider first', 'error');
                    input.value = '';
                    return;
                }
                
                // Check if AWB already assigned to this rider
                if (assignments[currentAssignmentRider].includes(awb)) {
                    showNotification('‚ö†Ô∏è AWB already assigned to this rider', 'error');
                    input.value = '';
                    return;
                }
                
                // Add to assignments
                assignments[currentAssignmentRider].push(awb);
                
                // Check if this is a red parcel and mark as scanned
                const rider = riders.find(r => r.id === currentAssignmentRider);
                const riderName = rider.name;
                
                if (redParcels[riderName]) {
                    let isRedParcel = false;
                    
                    // Check in Unattempt
                    if (redParcels[riderName].Unattempt.includes(awb)) {
                        isRedParcel = true;
                    }
                    // Check in Customer Unavailable
                    else if (redParcels[riderName]['Customer Unavailable'].includes(awb)) {
                        isRedParcel = true;
                    }
                    // Check in RTO (blocked, should not be assigned)
                    else if (redParcels[riderName].RTO.includes(awb)) {
                        showNotification('‚ö†Ô∏è WARNING: This is an RTO parcel (blocked)!', 'error');
                    }
                    
                    // Mark as scanned if it's a red parcel
                    if (isRedParcel && !redParcels[riderName].scanned.includes(awb)) {
                        redParcels[riderName].scanned.push(awb);
                        updateRedParcelsDisplay();
                    }
                }
                
                saveData();
                updateAssignmentDisplay();
                updateStats();
                
                showNotification(`‚úÖ ${awb} assigned`, 'success');
                input.value = '';
            }
        }

        function updateAssignmentDisplay() {
            if (!currentAssignmentRider) return;
            
            const rider = riders.find(r => r.id === currentAssignmentRider);
            const assigned = assignments[currentAssignmentRider] || [];
            
            const summary = document.getElementById('assignmentSummary');
            summary.innerHTML = `
                <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                    <strong>üë§ ${rider.name}</strong><br>
                    üì¶ Total Assigned: <span style="color: #667eea; font-size: 1.2em; font-weight: bold;">${assigned.length}</span>
                </div>
            `;
            
            const list = document.getElementById('assignmentList');
            if (assigned.length === 0) {
                list.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No parcels assigned yet</p>';
                document.getElementById('completeBtn').style.display = 'none';
                document.getElementById('cancelBtn').style.display = 'none';
            } else {
                list.innerHTML = `
                    <h4 style="margin-bottom: 15px;">Assigned AWBs:</h4>
                    <div class="awb-list">
                        ${assigned.map((awb, idx) => `
                            <div class="awb-item">
                                <span><strong>${idx + 1}.</strong> ${awb}</span>
                                <button class="btn btn-danger btn-small" onclick="removeAssignment('${awb}')">Remove</button>
                            </div>
                        `).join('')}
                    </div>
                `;
                document.getElementById('completeBtn').style.display = 'inline-flex';
                document.getElementById('cancelBtn').style.display = 'inline-flex';
            }
        }

        function removeAssignment(awb) {
            if (!currentAssignmentRider) return;
            
            assignments[currentAssignmentRider] = assignments[currentAssignmentRider].filter(a => a !== awb);
            
            // Remove from red parcels scanned if it was there
            const rider = riders.find(r => r.id === currentAssignmentRider);
            const riderName = rider.name;
            
            if (redParcels[riderName] && redParcels[riderName].scanned.includes(awb)) {
                redParcels[riderName].scanned = redParcels[riderName].scanned.filter(a => a !== awb);
                updateRedParcelsDisplay();
            }
            
            saveData();
            updateAssignmentDisplay();
            updateStats();
            
            showNotification('AWB removed', 'success');
        }

        function completeAssignment() {
            if (!currentAssignmentRider) return;
            
            const rider = riders.find(r => r.id === currentAssignmentRider);
            const assigned = assignments[currentAssignmentRider] || [];
            
            if (assigned.length === 0) {
                showNotification('‚ö†Ô∏è No parcels to assign', 'error');
                return;
            }
            
            // Add to history
            assignmentHistory.push({
                date: new Date().toISOString(),
                rider: rider.name,
                parcels: [...assigned],
                count: assigned.length
            });
            
            saveData();
            
            showNotification(`‚úÖ ${assigned.length} parcels assigned to ${rider.name}`, 'success');
            
            // Reset
            currentAssignmentRider = null;
            document.getElementById('assignRider').value = '';
            document.getElementById('assignmentSummary').innerHTML = '';
            document.getElementById('assignmentList').innerHTML = '';
            document.getElementById('completeBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('redParcelsInAssignment').style.display = 'none';
            
            updateStats();
        }

        function cancelAssignment() {
            if (confirm('Cancel current assignment?')) {
                // Remove scanned status from red parcels
                if (currentAssignmentRider) {
                    const rider = riders.find(r => r.id === currentAssignmentRider);
                    const riderName = rider.name;
                    
                    if (redParcels[riderName]) {
                        redParcels[riderName].scanned = [];
                    }
                }
                
                currentAssignmentRider = null;
                document.getElementById('assignRider').value = '';
                document.getElementById('assignmentSummary').innerHTML = '';
                document.getElementById('assignmentList').innerHTML = '';
                document.getElementById('completeBtn').style.display = 'none';
                document.getElementById('cancelBtn').style.display = 'none';
                document.getElementById('redParcelsInAssignment').style.display = 'none';
                
                saveData();
                showNotification('Assignment cancelled', 'info');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RED PARCELS DISPLAY IN ASSIGNMENT SECTION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function updateRedParcelsDisplay() {
            if (!currentAssignmentRider) return;
            
            const rider = riders.find(r => r.id === currentAssignmentRider);
            const riderName = rider.name;
            
            if (!redParcels[riderName]) return;
            
            const parcels = redParcels[riderName];
            
            // Update stats
            document.getElementById('redStatRTO').textContent = parcels.RTO.length;
            document.getElementById('redStatUnattempt').textContent = parcels.Unattempt.length;
            document.getElementById('redStatUnavailable').textContent = parcels['Customer Unavailable'].length;
            document.getElementById('redStatScanned').textContent = parcels.scanned.length;
            
            // Display filtered parcels
            filterRedParcelsDisplay();
        }

        function filterRedParcelsDisplay() {
            if (!currentAssignmentRider) return;
            
            const rider = riders.find(r => r.id === currentAssignmentRider);
            const riderName = rider.name;
            
            if (!redParcels[riderName]) return;
            
            const parcels = redParcels[riderName];
            const filter = document.getElementById('redParcelsFilter').value;
            const container = document.getElementById('redParcelsListContainer');
            
            let displayParcels = [];
            
            switch(filter) {
                case 'rto':
                    displayParcels = parcels.RTO.map(awb => ({ awb, status: 'rto', scanned: false }));
                    break;
                case 'unattempt':
                    displayParcels = parcels.Unattempt.map(awb => ({ 
                        awb, 
                        status: 'unattempt', 
                        scanned: parcels.scanned.includes(awb) 
                    }));
                    break;
                case 'unavailable':
                    displayParcels = parcels['Customer Unavailable'].map(awb => ({ 
                        awb, 
                        status: 'unavailable', 
                        scanned: parcels.scanned.includes(awb) 
                    }));
                    break;
                case 'scanned':
                    displayParcels = parcels.scanned.map(awb => {
                        let status = 'scanned';
                        if (parcels.Unattempt.includes(awb)) status = 'unattempt';
                        else if (parcels['Customer Unavailable'].includes(awb)) status = 'unavailable';
                        return { awb, status, scanned: true };
                    });
                    break;
                default: // 'all'
                    displayParcels = [
                        ...parcels.Unattempt.map(awb => ({ 
                            awb, 
                            status: 'unattempt', 
                            scanned: parcels.scanned.includes(awb) 
                        })),
                        ...parcels['Customer Unavailable'].map(awb => ({ 
                            awb, 
                            status: 'unavailable', 
                            scanned: parcels.scanned.includes(awb) 
                        }))
                    ];
            }
            
            if (displayParcels.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No parcels in this category</p>';
                return;
            }
            
            container.innerHTML = displayParcels.map(p => {
                const statusClass = p.scanned ? 'scanned' : p.status;
                const statusText = p.scanned ? 'SCANNED ‚úì' : 
                                  p.status === 'rto' ? 'RTO (Blocked)' :
                                  p.status === 'unattempt' ? 'Unattempt' :
                                  'Customer Unavailable';
                
                return `
                    <div class="red-parcel-item ${statusClass}">
                        <span style="font-weight: bold;">${p.awb}</span>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                `;
            }).join('');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // YESTERDAY STATUS FILE HANDLING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function handleYesterdayFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const filename = file.name.toLowerCase();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                if (filename.endsWith('.csv')) {
                    parseYesterdayCSVFile(e.target.result, filename);
                } else {
                    parseYesterdayExcelFile(e.target.result, filename);
                }
                
                // Save as today's data for tomorrow's rotation
                localStorage.setItem('todayStatusData', JSON.stringify(yesterdayStatus));
                localStorage.setItem(LAST_UPDATE_KEY, new Date().toDateString());
            };
            
            if (filename.endsWith('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function parseYesterdayExcelFile(data, filename) {
            const statusDiv = document.getElementById('yesterdayFileUploadStatus');
            
            try {
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    statusDiv.innerHTML = '<div class="upload-status error">‚ùå File appears empty</div>';
                    return;
                }
                
                yesterdayStatus = {};
                redParcels = {};
                let processed = 0;
                let errors = 0;
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    
                    if (!row || row.length < 3) {
                        errors++;
                        continue;
                    }
                    
                    const riderName = String(row[0] || '').trim();
                    const awb = String(row[1] || '').trim().toUpperCase();
                    let status = String(row[2] || '').toLowerCase();
                    
                    if (!riderName || !awb || !status) {
                        errors++;
                        continue;
                    }
                    
                    // Normalize status
                    let normalizedStatus;
                    if (status.includes('deliver') && !status.includes('not') && !status.includes('un')) {
                        normalizedStatus = 'Delivered';
                    } else if (status.includes('rto')) {
                        normalizedStatus = 'RTO';
                    } else if (status.includes('unattempt') || status.includes('not attempt')) {
                        normalizedStatus = 'Unattempt';
                    } else if (status.includes('customer') || status.includes('unavailable')) {
                        normalizedStatus = 'Customer Unavailable';
                    } else {
                        errors++;
                        continue;
                    }
                    
                    if (!yesterdayStatus[riderName]) {
                        yesterdayStatus[riderName] = {};
                    }
                    yesterdayStatus[riderName][awb] = normalizedStatus;
                    
                    // Add to red parcels
                    if (normalizedStatus !== 'Delivered') {
                        if (!redParcels[riderName]) {
                            redParcels[riderName] = {
                                'RTO': [],
                                'Unattempt': [],
                                'Customer Unavailable': [],
                                'scanned': []
                            };
                        }
                        redParcels[riderName][normalizedStatus].push(awb);
                    }
                    
                    processed++;
                }
                
                saveData();
                
                statusDiv.innerHTML = `
                    <div class="upload-status success">
                        ‚úÖ Today's status uploaded & auto-saved for tomorrow!<br>
                        üì¶ Processed: ${processed} records<br>
                        ${errors > 0 ? `‚ö†Ô∏è Skipped: ${errors} invalid records<br>` : ''}
                        üîÑ This data will automatically become "Yesterday's data" tomorrow
                    </div>
                `;
                
                showNotification(`‚úÖ File uploaded & saved: ${processed} records`, 'success');
                displayYesterdayStatusSummary();
                updateStats();
                
            } catch (error) {
                console.error('Parse error:', error);
                statusDiv.innerHTML = `<div class="upload-status error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function parseYesterdayCSVFile(text, filename) {
            const statusDiv = document.getElementById('yesterdayFileUploadStatus');
            
            try {
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                
                if (lines.length < 2) {
                    statusDiv.innerHTML = '<div class="upload-status error">‚ùå File appears empty</div>';
                    return;
                }
                
                yesterdayStatus = {};
                redParcels = {};
                let processed = 0;
                let errors = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',').map(p => p.trim());
                    
                    if (parts.length < 3) {
                        errors++;
                        continue;
                    }
                    
                    const riderName = parts[0];
                    const awb = parts[1].toUpperCase();
                    let status = parts[2].toLowerCase();
                    
                    if (!riderName || !awb || !status) {
                        errors++;
                        continue;
                    }
                    
                    // Normalize status
                    let normalizedStatus;
                    if (status.includes('deliver') && !status.includes('not') && !status.includes('un')) {
                        normalizedStatus = 'Delivered';
                    } else if (status.includes('rto')) {
                        normalizedStatus = 'RTO';
                    } else if (status.includes('unattempt') || status.includes('not attempt')) {
                        normalizedStatus = 'Unattempt';
                    } else if (status.includes('customer') || status.includes('unavailable')) {
                        normalizedStatus = 'Customer Unavailable';
                    } else {
                        errors++;
                        continue;
                    }
                    
                    if (!yesterdayStatus[riderName]) {
                        yesterdayStatus[riderName] = {};
                    }
                    yesterdayStatus[riderName][awb] = normalizedStatus;
                    
                    // Add to red parcels
                    if (normalizedStatus !== 'Delivered') {
                        if (!redParcels[riderName]) {
                            redParcels[riderName] = {
                                'RTO': [],
                                'Unattempt': [],
                                'Customer Unavailable': [],
                                'scanned': []
                            };
                        }
                        redParcels[riderName][normalizedStatus].push(awb);
                    }
                    
                    processed++;
                }
                
                saveData();
                
                statusDiv.innerHTML = `
                    <div class="upload-status success">
                        ‚úÖ Today's status uploaded & auto-saved for tomorrow!<br>
                        üì¶ Processed: ${processed} records<br>
                        ${errors > 0 ? `‚ö†Ô∏è Skipped: ${errors} invalid records<br>` : ''}
                        üîÑ This data will automatically become "Yesterday's data" tomorrow
                    </div>
                `;
                
                showNotification(`‚úÖ CSV uploaded & saved: ${processed} records`, 'success');
                displayYesterdayStatusSummary();
                updateStats();
                
            } catch (error) {
                console.error('Parse error:', error);
                statusDiv.innerHTML = `<div class="upload-status error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function displayYesterdayStatusSummary() {
            const display = document.getElementById('yesterdayStatusDisplay');
            
            if (Object.keys(yesterdayStatus).length === 0) {
                display.innerHTML = '';
                return;
            }
            
            let totalParcels = 0;
            let riderCount = 0;
            
            Object.entries(yesterdayStatus).forEach(([rider, parcels]) => {
                totalParcels += Object.keys(parcels).length;
                riderCount++;
            });
            
            display.innerHTML = `
                <div class="alert alert-success">
                    <strong>üìä Summary</strong><br>
                    Total Riders: ${riderCount}<br>
                    Total Records: ${totalParcels}
                </div>
            `;
        }

        function viewYesterdayStatus() {
            if (Object.keys(yesterdayStatus).length === 0) {
                showNotification('‚ö†Ô∏è No yesterday file uploaded', 'error');
                return;
            }
            
            const content = document.getElementById('unassignedContent');
            
            let ridersHTML = '';
            Object.entries(redParcels).forEach(([riderName, parcels]) => {
                const total = parcels.RTO.length + parcels.Unattempt.length + parcels['Customer Unavailable'].length;
                const scanned = parcels.scanned.length;
                const pending = total - parcels.RTO.length - scanned;
                
                ridersHTML += `
                    <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ef4444;">
                        <h4 style="color: #ef4444;">üë§ ${riderName}</h4>
                        <div style="margin-top: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="color: #666; font-size: 0.8em;">Total</div>
                                <div style="font-size: 1.3em; font-weight: bold;">${total}</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="color: #666; font-size: 0.8em;">Scanned</div>
                                <div style="font-size: 1.3em; font-weight: bold; color: #10b981;">${scanned}</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="color: #666; font-size: 0.8em;">Pending</div>
                                <div style="font-size: 1.3em; font-weight: bold; color: #f59e0b;">${pending}</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="color: #666; font-size: 0.8em;">RTO (Blocked)</div>
                                <div style="font-size: 1.3em; font-weight: bold; color: #ef4444;">${parcels.RTO.length}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = `
                <div class="alert alert-info">
                    <strong>üî¥ Yesterday's Pending Parcels</strong>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>Total Riders:</strong> ${Object.keys(redParcels).length}
                </div>
                ${ridersHTML}
            `;
            
            openSidebar();
        }

        function clearYesterdayStatus() {
            const totalRecords = Object.values(yesterdayStatus).reduce((sum, awbs) => sum + Object.keys(awbs).length, 0);
            
            if (totalRecords === 0) {
                showNotification('‚ö†Ô∏è No yesterday data to clear', 'error');
                return;
            }
            
            if (confirm(`Clear yesterday's status data?\n\nTotal records: ${totalRecords}\nRiders: ${Object.keys(yesterdayStatus).length}`)) {
                yesterdayStatus = {};
                redParcels = {};
                localStorage.removeItem('todayStatusData');
                localStorage.removeItem('yesterdayStatusData');
                
                saveData();
                document.getElementById('yesterdayFileUploadStatus').innerHTML = '';
                document.getElementById('yesterdayStatusDisplay').innerHTML = '';
                showNotification('‚úÖ Yesterday\'s data cleared', 'success');
                updateStats();
            }
        }

        function showMissingRedParcels() {
            const rider = riders.find(r => r.id === currentAssignmentRider);
            if (!rider) return;
            
            const riderName = rider.name;
            
            if (!redParcels[riderName]) {
                showNotification('‚ö†Ô∏è No red parcels for this rider', 'error');
                return;
            }
            
            const parcels = redParcels[riderName];
            const allRed = [
                ...parcels.Unattempt.map(awb => ({ awb, status: 'Unattempt' })),
                ...parcels['Customer Unavailable'].map(awb => ({ awb, status: 'Customer Unavailable' }))
            ];
            
            const missing = allRed.filter(p => !parcels.scanned.includes(p.awb));
            
            const content = document.getElementById('unassignedContent');
            
            if (missing.length === 0) {
                content.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ Perfect!</strong>
                        <p style="margin-top: 10px;">All re-assignable red parcels have been scanned.</p>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>‚ùå Missing Red Parcels - ${riderName}</strong>
                    </div>
                    
                    <div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ef4444;">
                        <strong>Total Missing:</strong> ${missing.length} parcels (Unattempt + Customer Unavailable only)
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <strong>Note:</strong> RTO parcels (${parcels.RTO.length}) are blocked and not counted as missing.
                    </div>
                    
                    <h4 style="margin-bottom: 15px;">üìã Missing AWB List:</h4>
                    <div class="awb-list" style="max-height: 500px;">
                        ${missing.map((p, idx) => {
                            const statusColor = p.status === 'Unattempt' ? '#fbbf24' : '#1e40af';
                            return `
                                <div class="awb-item">
                                    <span>
                                        <strong>${idx + 1}.</strong> ${p.awb} 
                                        <span style="color: ${statusColor}; font-weight: bold;">(${p.status})</span>
                                    </span>
                                    <button class="btn btn-primary btn-small" onclick="copyAWB('${p.awb}')">Copy</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            openSidebar();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATS UPDATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function updateStats() {
            document.getElementById('totalRiders').textContent = riders.length;
            
            const totalAssigned = Object.values(assignments).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('totalAssignments').textContent = totalAssigned;
            
            const totalRed = Object.values(redParcels).reduce((sum, parcels) => {
                return sum + parcels.RTO.length + parcels.Unattempt.length + parcels['Customer Unavailable'].length;
            }, 0);
            document.getElementById('totalRedParcels').textContent = totalRed;
            
            const totalScanned = Object.values(redParcels).reduce((sum, parcels) => {
                return sum + parcels.scanned.length;
            }, 0);
            document.getElementById('totalScannedRed').textContent = totalScanned;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UTILITIES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function openSidebar() {
            document.getElementById('sidebar').classList.add('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
        }

        function copyAWB(awb) {
            navigator.clipboard.writeText(awb).then(() => {
                showNotification(`‚úÖ Copied: ${awb}`, 'success');
            });
        }
    </script>
</body>
</html>